version: "3.7"

services:
  chatwoot_app:
    image: chatwoot/chatwoot:v4.9.2
    command: bundle exec rails s -p 3000 -b 0.0.0.0
    entrypoint: docker/entrypoints/rails.sh
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - edge
      - data
    environment:
      - INSTALLATION_NAME=chatwoot
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker

      - SECRET_KEY_BASE=123458bb7ef6402f6a8bcf5d3be54321

      - FRONTEND_URL=https://${DOMAIN_CHAT}
      - ASSET_CDN_HOST=https://${DOMAIN_CHAT}
      - DEFAULT_LOCALE=pt_BR
      - FORCE_SSL=true
      - ENABLE_ACCOUNT_SIGNUP=false

      - REDIS_URL=redis://redis:6379

      - POSTGRES_HOST=postgres
      - POSTGRES_USERNAME=postgres
      - POSTGRES_PASSWORD=AdminAdmin
      - POSTGRES_DATABASE=chatwoot

      - ACTIVE_STORAGE_SERVICE=local
      - RAILS_LOG_TO_STDOUT=true
      - USE_INBOX_AVATAR_FOR_BOT=true

      - MAILER_SENDER_EMAIL=Chatwoot <felipe.rasche@pulse4mind.com>
      - SMTP_DOMAIN=pulse4mind.com
      - SMTP_ADDRESS=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USERNAME=felipe.rasche@pulse4mind.com
      - SMTP_PASSWORD=txxhhfhtiirwsfau
      - SMTP_AUTHENTICATION=login
      - SMTP_ENABLE_STARTTLS_AUTO=true
      - SMTP_OPENSSL_VERIFY_MODE=peer
      - MAILER_INBOUND_EMAIL_DOMAIN=pulse4mind.com
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.chatwoot_app.rule=Host(`${DOMAIN_CHAT}`)
        - traefik.http.routers.chatwoot_app.entrypoints=websecure
        - traefik.http.routers.chatwoot_app.tls.certresolver=letsencryptresolver
        - traefik.http.services.chatwoot_app.loadbalancer.server.port=3000

  chatwoot_sidekiq:
    image: chatwoot/chatwoot:v4.9.2
    command: bundle exec sidekiq -C config/sidekiq.yml
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - data
    environment:
      - INSTALLATION_NAME=chatwoot
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker

      - SECRET_KEY_BASE=123458bb7ef6402f6a8bcf5d3be54321

      - FRONTEND_URL=https://${DOMAIN_CHAT}
      - DEFAULT_LOCALE=pt_BR
      - FORCE_SSL=true
      - ENABLE_ACCOUNT_SIGNUP=false

      - REDIS_URL=redis://redis:6379

      - POSTGRES_HOST=postgres
      - POSTGRES_USERNAME=postgres
      - POSTGRES_PASSWORD=AdminAdmin
      - POSTGRES_DATABASE=chatwoot

      - ACTIVE_STORAGE_SERVICE=local
      - RAILS_LOG_TO_STDOUT=true
      - USE_INBOX_AVATAR_FOR_BOT=true

      - MAILER_SENDER_EMAIL=Chatwoot <felipe.rasche@pulse4mind.com>
      - SMTP_DOMAIN=pulse4mind.com
      - SMTP_ADDRESS=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USERNAME=felipe.rasche@pulse4mind.com
      - SMTP_PASSWORD=txxhhfhtiirwsfau
      - SMTP_AUTHENTICATION=login
      - SMTP_ENABLE_STARTTLS_AUTO=true
      - SMTP_OPENSSL_VERIFY_MODE=peer
      - MAILER_INBOUND_EMAIL_DOMAIN=pulse4mind.com
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

volumes:
  chatwoot_data:
    external: true
    name: chatwoot_data

networks:
  edge:
    external: true
    name: "${EDGE_NETWORK}"
  data:
    external: true
    name: "${DATA_NETWORK}"
