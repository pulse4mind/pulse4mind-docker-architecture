version: "3.8"

services:
  redis:
    image: redis:7-alpine
    networks:
      - data
    volumes:
      - redis_data:/data

    secrets:
      - redis_password

    command: >
      sh -lc 'exec redis-server
      --appendonly yes
      --port 6379
      --maxmemory 768mb
      --maxmemory-policy allkeys-lru
      --save ""
      --protected-mode yes
      --requirepass "$(cat /run/secrets/redis_password)"'

    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 1024M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 60s

    stop_grace_period: 30s

    ulimits:
      nofile:
        soft: 10032
        hard: 10032

    healthcheck:
      test: ["CMD-SHELL", 'redis-cli -a "$(cat /run/secrets/redis_password)" ping | grep -q PONG']
      interval: 10s
      timeout: 3s
      retries: 5

secrets:
  redis_password:
    external: true
    name: thermas_prod_redis_password

volumes:
  redis_data:
    external: true
    name: "${TENANT}_${ENV}_redis_data"

networks:
  data:
    external: true
    name: "${DATA_NETWORK}"
